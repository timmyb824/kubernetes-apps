apiVersion: v1
kind: Namespace
metadata:
  name: manyfold
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: manyfold-config
  namespace: manyfold
data:
  # --- Manyfold core ---
  DATABASE_ADAPTER: "postgresql"
  DATABASE_HOST: "<path:secret/data/database#PG_HOST>"
  DATABASE_PORT: "5432"
  DATABASE_NAME: "manyfold"
  DATABASE_USER: "<path:secret/data/database#PG_USER>"
  DATABASE_PASSWORD: "<path:secret/data/database#PG_PASSWORD>"
  SECRET_KEY_BASE: "<path:secret/data/argocd#MANYFOLD_SECRET_KEY_BASE>"

  # --- Redis (external) ---
  # manyfold expects REDIS_URL like the compose example
  REDIS_URL: "<path:secret/data/database#REDIS_CONN_STRING>/3"

  # --- Container user ---
  PUID: "1000"
  PGID: "1000"

  # Optional examples you may want later:
  # RAILS_LOG_TO_STDOUT: "true"
  MANYFOLD_PUBLIC_HOST: "manyfold.local.timmybtech.com"
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: manyfold-data
  namespace: manyfold
spec:
  accessModes: ["ReadWriteOnce"]
  storageClassName: "nfs-csi-synologynas"
  resources:
    requests:
      storage: 50Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: manyfold
  namespace: manyfold
  labels:
    app: manyfold
spec:
  replicas: 1
  selector:
    matchLabels:
      app: manyfold
  template:
    metadata:
      labels:
        app: manyfold
        app.kubernetes.io/name: manyfold
    spec:
      terminationGracePeriodSeconds: 60
      initContainers:
        - name: init-tmp
          image: busybox:1.36
          command:
            - sh
            - -lc
            - |
              mkdir -p /var/tmp/manyfold-tmp /tmp/bundle
              chown -R 1000:1000 /var/tmp/manyfold-tmp /tmp/bundle
              chmod 700 /var/tmp/manyfold-tmp
              chmod 755 /tmp
          volumeMounts:
            - name: vartmp
              mountPath: /var/tmp
            - name: tmp
              mountPath: /tmp
      containers:
        - name: manyfold
          image: ghcr.io/manyfold3d/manyfold:0.130.4
          imagePullPolicy: IfNotPresent

          env:
            - name: HOME
              value: /tmp
            - name: BUNDLE_USER_HOME
              value: /tmp/bundle
            - name: TMPDIR
              value: /var/tmp/manyfold-tmp
            - name: TMP
              value: /var/tmp/manyfold-tmp
            - name: TEMP
              value: /var/tmp/manyfold-tmp
          envFrom:
            - configMapRef:
                name: manyfold-config

          ports:
            - name: http
              containerPort: 3214

          volumeMounts:
            - name: vartmp
              mountPath: /var/tmp
            - name: tmp
              mountPath: /tmp
            - name: run
              mountPath: /run
            - name: data
              mountPath: /var/lib/manyfold

          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            capabilities:
              drop: ["ALL"]
              add: ["CHOWN", "DAC_OVERRIDE", "SETUID", "SETGID"]

          readinessProbe:
            httpGet:
              path: /health
              port: http
            periodSeconds: 10
            timeoutSeconds: 10
            failureThreshold: 6

          livenessProbe:
            httpGet:
              path: /health
              port: http
            periodSeconds: 20
            timeoutSeconds: 10
            failureThreshold: 6

          resources:
            requests:
              cpu: "250m"
              memory: "512Mi"
            limits:
              cpu: "1"
              memory: "2Gi"

      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: manyfold-data
        - name: run
          emptyDir: {}
        - name: tmp
          emptyDir: {}
        - name: vartmp
          emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: manyfold
  namespace: manyfold
  labels:
    app: manyfold
spec:
  selector:
    app: manyfold
  ports:
    - name: http
      port: 3214
      targetPort: http
  type: ClusterIP
---
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: manyfold-internal
  namespace: manyfold
  annotations:
    kubernetes.io/ingress.class: traefik-external
spec:
  entryPoints:
    - websecure
  routes:
    - match: Host(`manyfold.local.timmybtech.com`)
      kind: Rule
      services:
        - name: manyfold
          port: 3214
  tls:
    secretName: local-timmybtech-com-tls
